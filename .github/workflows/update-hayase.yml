name: Update Hayase

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 */3 * *" # every Sunday

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Nix
        uses: cachix/install-nix-action@v27

      - name: Install dependencies
        run: |
          nix profile install nixpkgs#jq nixpkgs#curl nixpkgs#nix-prefetch

      - name: Fetch latest version + SHA
        run: |
          LATEST=$(curl -s https://api.github.com/repos/ClearVision/Miru/tags | jq -r '.[0].name')
          VERSION="${LATEST#v}"

          echo "Latest version: $VERSION"
          URL="https://github.com/ClearVision/Miru/archive/refs/tags/v$VERSION.tar.gz"
          SHA=$(nix-prefetch-url --unpack "$URL")

          echo "Updating version.json..."
          jq -n --arg version "$VERSION" --arg sha256 "$SHA" \
            '{version: $version, sha256: $sha256}' > version.json

      - name: Commit version bump
        uses: EndBug/add-and-commit@v9
        with:
          add: "version.json"
          message: "chore: bump hayase to latest version"

      - name: Open PR (optional)
        if: github.ref == 'refs/heads/main'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: bump hayase version"
          title: "Update hayase to latest version"
          body: "Automated update triggered by GitHub Actions"
