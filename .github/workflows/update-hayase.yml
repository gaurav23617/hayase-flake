name: Update Hayase

on:
  schedule:
    - cron: "0 2 * * 1" # Every Monday at 2 AM UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Make update script executable
        run: |
          echo "ğŸ”§ Making update script executable..."
          chmod +x update.sh
          echo "âœ… Update script is now executable"

      - name: Run update script
        id: update
        run: |
          echo "ğŸš€ Running update script..."
          set +e  # Don't exit on error, we want to handle it ourselves

          # Capture the output of the update script
          if ./update.sh 2>&1 | tee update_output.txt; then
            echo "âœ… Update script completed successfully"
            
            # Check if update was needed
            if grep -q "Already up to date" update_output.txt; then
              echo "â„¹ï¸  No update needed - already at latest version"
              echo "update_needed=false" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“¦ Update available - processing..."
              echo "update_needed=true" >> $GITHUB_OUTPUT
              
              # Extract version information with better error handling
              if CURRENT=$(grep "Current version:" update_output.txt | cut -d' ' -f3); then
                echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
                echo "ğŸ“‹ Current version: $CURRENT"
              else
                echo "âš ï¸  Could not extract current version"
                echo "current_version=unknown" >> $GITHUB_OUTPUT
              fi
              
              if LATEST=$(grep "Latest version:" update_output.txt | cut -d' ' -f3); then
                echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
                echo "ğŸ“‹ Latest version: $LATEST"
              else
                echo "âš ï¸  Could not extract latest version"
                echo "latest_version=unknown" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "âŒ Update script failed!"
            echo "ğŸ“‹ Update script output:"
            cat update_output.txt
            echo "ğŸ“‹ Full error details above â¬†ï¸"
            exit 1
          fi

      - name: Fix pnpm hash
        if: steps.update.outputs.update_needed == 'true'
        run: |
          echo "ğŸ” Attempting initial build to get correct pnpm hash..."
          set +e  # Don't exit on error

          if nix build 2>&1 | tee build.log; then
            echo "âœ… Build succeeded on first try - no hash update needed"
          else
            echo "âš ï¸  Build failed (expected) - extracting pnpm hash..."
            
            # Show the build error for debugging
            echo "ğŸ“‹ Build output:"
            cat build.log
            
            # Extract the expected hash from build failure
            if grep -q "got:" build.log; then
              NEW_PNPM_HASH=$(grep "got:" build.log | tail -1 | sed 's/.*got: //')
              echo "âœ… Found pnpm hash: $NEW_PNPM_HASH"
              
              # Update the hash in package.nix
              echo "ğŸ”„ Updating pnpm hash in package.nix..."
              sed -i "s/hash = \"sha256-.*\"/hash = \"$NEW_PNPM_HASH\"/" package.nix
              echo "âœ… pnpm hash updated successfully"
            else
              echo "âŒ Could not extract pnpm hash from build output"
              echo "ğŸ“‹ Build log content:"
              cat build.log
              echo "ğŸ“‹ Expected to find 'got:' in the output above"
              exit 1
            fi
          fi

      - name: Test build
        if: steps.update.outputs.update_needed == 'true'
        run: |
          echo "ğŸ§ª Testing final build..."
          set +e  # Don't exit immediately on error

          if nix build .#hayase 2>&1 | tee final_build.log; then
            echo "âœ… Build successful!"
            echo "ğŸ“¦ Package built successfully - ready for PR"
          else
            echo "âŒ Final build failed!"
            echo "ğŸ“‹ Final build output:"
            cat final_build.log
            echo "ğŸ“‹ This indicates there might be other issues beyond pnpm hash"
            exit 1
          fi

      - name: Create Pull Request
        if: steps.update.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "hayase: ${{ steps.update.outputs.current_version }} -> ${{ steps.update.outputs.latest_version }}"
          title: "hayase: ${{ steps.update.outputs.current_version }} -> ${{ steps.update.outputs.latest_version }}"
          body: |
            ğŸ¤– Automated update of Hayase from ${{ steps.update.outputs.current_version }} to ${{ steps.update.outputs.latest_version }}

            This PR was automatically created by the update workflow.

            ## âœ… Completed Tasks
            - [x] Version updated in package.nix
            - [x] Source hash updated
            - [x] pnpm dependencies hash updated
            - [x] Build tested successfully

            ## ğŸ”— Links
            **Changelog:** https://github.com/ThaUnknown/miru/releases/tag/v${{ steps.update.outputs.latest_version }}
            **Source:** https://github.com/ThaUnknown/miru/archive/refs/tags/v${{ steps.update.outputs.latest_version }}.tar.gz

            ## ğŸ“‹ Version Info
            - **Previous:** `${{ steps.update.outputs.current_version }}`
            - **New:** `${{ steps.update.outputs.latest_version }}`

            Ready to merge! ğŸš€
          branch: update-hayase-${{ steps.update.outputs.latest_version }}
          delete-branch: true
          labels: |
            automated
            dependencies
